$schema: "https://moonrepo.dev/schemas/project.json"

type: "application"
language: "rust"

tasks:
  fmt-check:
    command: "cargo fmt --check"

  clippy:
    command: "cargo clippy --lib --bins -- -D warnings -D clippy::unwrap_used -D clippy::expect_used -D clippy::panic"

  check:
    command: "cargo check --all-targets"

  test:
    command: "cargo test"

  coverage-prereq:
    command: "cargo llvm-cov --version"

  coverage-report:
    command: "mkdir -p target/coverage && cargo llvm-cov --workspace --all-targets --summary-only --lcov --output-path target/coverage/lcov.info --ignore-filename-regex '(^tests/|/tests/|/target/)'"
    deps:
      - coverage-prereq

  coverage-html:
    command: "cargo llvm-cov --workspace --all-targets --html --output-dir target/coverage/html --ignore-filename-regex '(^tests/|/tests/|/target/)'"
    deps:
      - coverage-prereq

  coverage-gate:
    command: "cargo llvm-cov --workspace --all-targets --summary-only --fail-under-lines 80 --ignore-filename-regex '(^tests/|/tests/|/target/)'"
    deps:
      - coverage-prereq

  db-test:
    command: "bash scripts/run_db_test_from_env.sh"

  db-test-full:
    command: "bash scripts/run_db_test_suite.sh"

  build:
    command: "cargo build --release"

  install:
    command: "cp target/release/swarm ~/.local/bin/swarm && chmod +x ~/.local/bin/swarm"
    deps:
      - build

  fmt-fix:
    command: "cargo fmt"

  quick:
    deps:
      - fmt-check
      - check
      - clippy

  ci:
    deps:
      - fmt-check
      - clippy
      - check
      - test
      - db-test
      - coverage-gate
