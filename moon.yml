$schema: "https://moonrepo.dev/schemas/project.json"

type: "application"
language: "rust"

tasks:
  fmt-check:
    command: "cargo fmt --check"

  clippy:
    command: "cargo clippy --lib --bins -- -D warnings -D clippy::unwrap_used -D clippy::expect_used -D clippy::panic"

  check:
    command: "cargo check --all-targets"

  test:
    command: "cargo test"

  db-test:
    command: >-
      bash -lc 'DB_URL="${SWARM_TEST_DATABASE_URL:-${DATABASE_URL:-}}"; if [ -z "$DB_URL" ]; then printf "Skipping db-test: SWARM_TEST_DATABASE_URL or DATABASE_URL not set\n"; exit 0; fi; PGCONNECT_TIMEOUT=3 psql "$DB_URL" -c "SELECT 1" >/dev/null 2>&1 || { printf "db-test preflight failed: cannot reach database from configured URL\n"; exit 3; }; cargo test db::write_ops::tests:: -- --ignored --nocapture --test-threads=1'

  build:
    command: "cargo build --release"

  install:
    command: "cp target/release/swarm ~/.local/bin/swarm && chmod +x ~/.local/bin/swarm"
    deps:
      - build

  fmt-fix:
    command: "cargo fmt"

  quick:
    deps:
      - fmt-check
      - check
      - clippy

  ci:
    deps:
      - fmt-check
      - clippy
      - check
      - test
      - db-test
